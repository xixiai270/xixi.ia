<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#9333EA">
  <title>xixi.ai - AI Chat</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    body, html {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
    }
    #root {
      width: 100%;
      height: 100%;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useRef, useEffect } = React;

    // Lucide Icons as inline SVG components
    const Send = ({ className }) => (
      <svg className={className} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <line x1="22" y1="2" x2="11" y2="13"></line>
        <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
      </svg>
    );

    const Trash2 = ({ className }) => (
      <svg className={className} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <polyline points="3 6 5 6 21 6"></polyline>
        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
        <line x1="10" y1="11" x2="10" y2="17"></line>
        <line x1="14" y1="11" x2="14" y2="17"></line>
      </svg>
    );

    const MessageSquare = ({ className }) => (
      <svg className={className} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
      </svg>
    );

    const Plus = ({ className }) => (
      <svg className={className} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <line x1="12" y1="5" x2="12" y2="19"></line>
        <line x1="5" y1="12" x2="19" y2="12"></line>
      </svg>
    );

    const Sparkles = ({ className }) => (
      <svg className={className} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"></path>
        <path d="M5 3v4"></path>
        <path d="M19 17v4"></path>
        <path d="M3 5h4"></path>
        <path d="M17 19h4"></path>
      </svg>
    );

    function XixiAI() {
      const [messages, setMessages] = useState([]);
      const [input, setInput] = useState('');
      const [loading, setLoading] = useState(false);
      const [currentPage, setCurrentPage] = useState('chat');
      const [conversations, setConversations] = useState([]);
      const [currentConvId, setCurrentConvId] = useState(null);
      const [showImageGen, setShowImageGen] = useState(false);
      const [imagePrompt, setImagePrompt] = useState('');
      const [generatingImage, setGeneratingImage] = useState(false);
      const [level, setLevel] = useState(1);
      const [xp, setXp] = useState(0);
      const [showLevelUp, setShowLevelUp] = useState(false);
      const messagesEndRef = useRef(null);

      const xpToNextLevel = level * 100;
      const xpProgress = (xp / xpToNextLevel) * 100;

      useEffect(() => {
        loadConversations();
        loadProgress();
      }, []);

      const loadProgress = async () => {
        try {
          const result = await window.storage.get('user-progress');
          if (result) {
            const progress = JSON.parse(result.value);
            setLevel(progress.level || 1);
            setXp(progress.xp || 0);
          }
        } catch (error) {
          console.log('No saved progress');
        }
      };

      const saveProgress = async (newXp, newLevel) => {
        try {
          await window.storage.set('user-progress', JSON.stringify({
            level: newLevel,
            xp: newXp,
            timestamp: Date.now()
          }));
        } catch (error) {
          console.error('Error saving progress:', error);
        }
      };

      const addXp = (amount) => {
        const newXp = xp + amount;
        const neededXp = level * 100;
        
        if (newXp >= neededXp) {
          const newLevel = level + 1;
          const remainingXp = newXp - neededXp;
          setLevel(newLevel);
          setXp(remainingXp);
          setShowLevelUp(true);
          setTimeout(() => setShowLevelUp(false), 3000);
          saveProgress(remainingXp, newLevel);
        } else {
          setXp(newXp);
          saveProgress(newXp, level);
        }
      };

      const loadConversations = async () => {
        try {
          const keys = await window.storage.list('conv:');
          if (keys && keys.keys) {
            const convs = [];
            for (const key of keys.keys) {
              const result = await window.storage.get(key);
              if (result) {
                convs.push(JSON.parse(result.value));
              }
            }
            setConversations(convs.sort((a, b) => b.timestamp - a.timestamp));
          }
        } catch (error) {
          console.log('No previous conversations');
        }
      };

      const saveConversation = async () => {
        if (messages.length === 0) return;
        
        const convId = currentConvId || Date.now().toString();
        const conv = {
          id: convId,
          messages,
          timestamp: Date.now(),
          preview: messages[0]?.content.slice(0, 50) || 'New chat'
        };
        
        try {
          await window.storage.set(`conv:${convId}`, JSON.stringify(conv));
          setCurrentConvId(convId);
          loadConversations();
        } catch (error) {
          console.error('Error saving conversation:', error);
        }
      };

      const loadConversation = (conv) => {
        setMessages(conv.messages);
        setCurrentConvId(conv.id);
        setCurrentPage('chat');
      };

      const newChat = () => {
        setMessages([]);
        setCurrentConvId(null);
        setCurrentPage('chat');
      };

      const deleteConversation = async (convId) => {
        try {
          await window.storage.delete(`conv:${convId}`);
          loadConversations();
          if (currentConvId === convId) {
            newChat();
          }
        } catch (error) {
          console.error('Error deleting conversation:', error);
        }
      };

      const scrollToBottom = () => {
        messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
      };

      useEffect(() => {
        scrollToBottom();
      }, [messages]);

      useEffect(() => {
        if (messages.length > 0) {
          saveConversation();
        }
      }, [messages]);

      const sendMessage = async () => {
        if (!input.trim() || loading) return;

        const userMessage = { role: 'user', content: input };
        setMessages(prev => [...prev, userMessage]);
        setInput('');
        setLoading(true);

        try {
          const response = await fetch("https://api.anthropic.com/v1/messages", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              model: "claude-sonnet-4-20250514",
              max_tokens: 1000,
              messages: [...messages, userMessage],
            })
          });

          const data = await response.json();
          const assistantMessage = {
            role: 'assistant',
            content: data.content[0].text
          };
          
          setMessages(prev => [...prev, assistantMessage]);
          addXp(25);
        } catch (error) {
          console.error('Error:', error);
          setMessages(prev => [...prev, {
            role: 'assistant',
            content: 'Something went wrong. Try again!'
          }]);
        } finally {
          setLoading(false);
        }
      };

      const generateImage = async () => {
        if (!imagePrompt.trim() || generatingImage) return;

        const userMessage = { role: 'user', content: `[Image]: ${imagePrompt}`, type: 'image-request' };
        setMessages(prev => [...prev, userMessage]);
        const prompt = imagePrompt;
        setImagePrompt('');
        setGeneratingImage(true);

        try {
          const response = await fetch("https://api.anthropic.com/v1/messages", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              model: "claude-sonnet-4-20250514",
              max_tokens: 1024,
              messages: [
                {
                  role: "user",
                  content: `Generate an image based on this description: "${prompt}". Create detailed HTML/SVG artwork that matches this description. Make it visually stunning and creative. Respond ONLY with the HTML code, no explanations.`
                }
              ],
            })
          });

          const data = await response.json();
          const htmlContent = data.content[0].text;
          let cleanedHtml = htmlContent.replace(/```html\n?/g, '').replace(/```\n?/g, '').trim();
          
          setMessages(prev => [...prev, {
            role: 'assistant',
            content: cleanedHtml,
            type: 'image'
          }]);
          
          addXp(50);
        } catch (error) {
          console.error('Error:', error);
          setMessages(prev => [...prev, {
            role: 'assistant',
            content: "DÃ©solÃ©, une erreur s'est produite lors de la gÃ©nÃ©ration de l'image. ðŸ˜•"
          }]);
        } finally {
          setGeneratingImage(false);
        }
      };

      const clearChat = () => {
        setMessages([]);
        setCurrentConvId(null);
      };

      if (currentPage === 'history') {
        return (
          <div className="h-screen w-full bg-gradient-to-br from-purple-600 via-pink-400 to-orange-300 overflow-hidden flex flex-col relative">
            <div className="absolute inset-0 overflow-hidden opacity-20">
              <div className="absolute top-20 left-10 w-40 h-40 border-4 border-white transform rotate-45"></div>
              <div className="absolute bottom-40 right-20 w-60 h-60 rounded-full border-4 border-white"></div>
              <div className="absolute top-60 right-40 w-32 h-32 bg-yellow-300 transform rotate-12"></div>
            </div>

            <div className="px-6 py-5 bg-white/90 backdrop-blur-sm border-b-4 border-purple-600 relative z-10">
              <div className="flex items-center justify-between max-w-4xl mx-auto">
                <h1 className="text-2xl font-black text-purple-900 tracking-tight">Conversations</h1>
                <button
                  onClick={newChat}
                  className="px-4 py-2 rounded-xl bg-gradient-to-r from-purple-600 to-pink-500 text-white font-bold hover:shadow-lg transition-all flex items-center gap-2"
                >
                  <Plus className="w-4 h-4" />
                  New
                </button>
              </div>
            </div>

            <div className="flex-1 overflow-y-auto px-4 py-6 relative z-10">
              {conversations.length === 0 ? (
                <div className="h-full flex flex-col items-center justify-center text-center">
                  <div className="w-20 h-20 rounded-full bg-white/90 flex items-center justify-center mb-4">
                    <MessageSquare className="w-10 h-10 text-purple-600" />
                  </div>
                  <p className="text-white text-lg font-bold">No conversations yet</p>
                </div>
              ) : (
                <div className="space-y-3 max-w-4xl mx-auto">
                  {conversations.map((conv) => (
                    <div
                      key={conv.id}
                      className="bg-white/90 backdrop-blur-sm rounded-2xl p-4 border-2 border-purple-300 hover:border-purple-600 hover:shadow-xl transition-all cursor-pointer"
                      onClick={() => loadConversation(conv)}
                    >
                      <div className="flex items-start justify-between gap-3">
                        <div className="flex-1 min-w-0">
                          <p className="text-gray-900 font-bold mb-1 line-clamp-2 text-sm">{conv.preview}</p>
                          <span className="text-purple-600 text-xs font-semibold">
                            {new Date(conv.timestamp).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}
                          </span>
                        </div>
                        <button
                          onClick={(e) => {
                            e.stopPropagation();
                            deleteConversation(conv.id);
                          }}
                          className="p-2 hover:bg-red-100 rounded-lg transition-all flex-shrink-0"
                        >
                          <Trash2 className="w-4 h-4 text-gray-500 hover:text-red-600" />
                        </button>
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </div>

            <div className="p-4 bg-white/90 backdrop-blur-sm border-t-4 border-purple-600 relative z-10">
              <div className="max-w-4xl mx-auto">
                <button
                  onClick={() => setCurrentPage('chat')}
                  className="w-full py-3 bg-gradient-to-r from-purple-600 to-pink-500 text-white rounded-xl font-bold hover:shadow-lg transition-all"
                >
                  Back to Chat
                </button>
              </div>
            </div>
          </div>
        );
      }

      return (
        <div className="h-screen w-full bg-gradient-to-br from-purple-600 via-pink-400 to-orange-300 overflow-hidden flex flex-col relative">
          <div className="absolute inset-0 overflow-hidden opacity-20">
            <div className="absolute top-20 left-10 w-40 h-40 border-4 border-white transform rotate-45"></div>
            <div className="absolute bottom-40 right-20 w-60 h-60 rounded-full border-4 border-white"></div>
            <div className="absolute top-60 right-40 w-32 h-32 bg-yellow-300 transform rotate-12"></div>
            <div className="absolute bottom-20 left-40 w-24 h-24 border-4 border-white rounded-full"></div>
            <div className="absolute top-1/3 left-1/2 w-48 h-48 bg-purple-800 opacity-30 transform -rotate-12"></div>
          </div>

          <div className="px-6 py-5 bg-white/90 backdrop-blur-sm border-b-4 border-purple-600 relative z-10">
            <div className="flex items-center justify-between max-w-4xl mx-auto mb-3">
              <h1 className="text-3xl font-black text-purple-900 tracking-tight">xixi.ai</h1>
              <div className="flex gap-2">
                <button
                  onClick={() => setCurrentPage('history')}
                  className="p-2.5 rounded-xl bg-purple-200 hover:bg-purple-300 transition-all"
                >
                  <MessageSquare className="w-5 h-5 text-purple-900" />
                </button>
                <button
                  onClick={clearChat}
                  className="p-2.5 rounded-xl bg-purple-200 hover:bg-purple-300 transition-all"
                >
                  <Trash2 className="w-5 h-5 text-purple-900" />
                </button>
              </div>
            </div>
            
            <div className="max-w-4xl mx-auto">
              <div className="flex items-center gap-3">
                <div className="flex items-center gap-2 bg-gradient-to-r from-purple-600 to-pink-500 px-4 py-2 rounded-xl border-2 border-purple-900 shadow-lg">
                  <span className="text-white font-black text-lg">LVL {level}</span>
                </div>
                
                <div className="flex-1 relative h-8 bg-gray-800 rounded-xl border-2 border-purple-900 overflow-hidden shadow-inner">
                  <div 
                    className="absolute inset-0 bg-gradient-to-r from-yellow-400 via-orange-500 to-pink-500 transition-all duration-500 ease-out"
                    style={{ width: `${xpProgress}%` }}
                  >
                    <div className="absolute inset-0 bg-gradient-to-t from-transparent to-white/30 animate-pulse"></div>
                  </div>
                  <div className="absolute inset-0 flex items-center justify-center">
                    <span className="text-white font-bold text-sm drop-shadow-lg z-10">
                      {xp} / {xpToNextLevel} XP
                    </span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          {showLevelUp && (
            <div className="absolute inset-0 z-50 flex items-center justify-center pointer-events-none">
              <div className="animate-bounce">
                <div className="bg-gradient-to-r from-yellow-400 via-orange-500 to-pink-500 px-12 py-6 rounded-3xl border-4 border-white shadow-2xl">
                  <h2 className="text-5xl font-black text-white text-center drop-shadow-lg">
                    LEVEL UP! ðŸŽ‰
                  </h2>
                  <p className="text-2xl font-bold text-white text-center mt-2">
                    Niveau {level}
                  </p>
                </div>
              </div>
            </div>
          )}

          <div className="flex-1 overflow-y-auto px-4 py-6 relative z-10">
            <div className="max-w-4xl mx-auto">
              {messages.length === 0 && (
                <div className="h-full flex flex-col items-center justify-center text-center px-6 py-20">
                  <div className="relative mb-6">
                    <svg width="180" height="180" viewBox="0 0 180 180" className="drop-shadow-2xl">
                      <defs>
                        <radialGradient id="glow3">
                          <stop offset="0%" stopColor="#FFD700" stopOpacity="0.5"/>
                          <stop offset="100%" stopColor="#FFD700" stopOpacity="0"/>
                        </radialGradient>
                      </defs>
                      
                      <circle cx="90" cy="95" r="75" fill="url(#glow3)"/>
                      
                      <line x1="70" y1="35" x2="70" y2="18" stroke="#000" strokeWidth="3" strokeLinecap="round"/>
                      <circle cx="70" cy="15" r="5" fill="#9333EA" stroke="#000" strokeWidth="2"/>
                      <circle cx="70" cy="15" r="2" fill="#fff" className="animate-pulse"/>
                      
                      <line x1="110" y1="35" x2="110" y2="18" stroke="#000" strokeWidth="3" strokeLinecap="round"/>
                      <circle cx="110" cy="15" r="5" fill="#EC4899" stroke="#000" strokeWidth="2"/>
                      <circle cx="110" cy="15" r="2" fill="#fff" className="animate-pulse"/>
                      
                      <circle cx="90" cy="95" r="58" fill="#fff" stroke="#000" strokeWidth="5"/>
                      <circle cx="90" cy="95" r="52" fill="#8B6F47" stroke="#000" strokeWidth="5"/>
                      
                      <circle cx="58" cy="60" r="20" fill="#8B6F47" stroke="#000" strokeWidth="4"/>
                      <circle cx="58" cy="60" r="11" fill="#D4A574" stroke="#000" strokeWidth="2"/>
                      
                      <circle cx="122" cy="60" r="20" fill="#8B6F47" stroke="#000" strokeWidth="4"/>
                      <circle cx="122" cy="60" r="11" fill="#D4A574" stroke="#000" strokeWidth="2"/>
                      
                      <ellipse cx="90" cy="108" rx="26" ry="22" fill="#D4A574" stroke="#000" strokeWidth="3"/>
                      
                      <ellipse cx="72" cy="85" rx="18" ry="22" fill="#fff" stroke="#000" strokeWidth="4"/>
                      <ellipse cx="72" cy="86" rx="15" ry="19" fill="#EC4899"/>
                      <ellipse cx="72" cy="85" rx="10" ry="13" fill="#000"/>
                      <ellipse cx="75" cy="81" rx="5" ry="7" fill="#fff"/>
                      <circle cx="70" cy="89" r="2.5" fill="#FDE047"/>
                      
                      <ellipse cx="108" cy="85" rx="18" ry="22" fill="#fff" stroke="#000" strokeWidth="4"/>
                      <ellipse cx="108" cy="86" rx="15" ry="19" fill="#0EA5E9"/>
                      <ellipse cx="108" cy="85" rx="10" ry="13" fill="#000"/>
                      <ellipse cx="111" cy="81" rx="5" ry="7" fill="#fff"/>
                      <circle cx="106" cy="89" r="2.5" fill="#FDE047"/>
                      
                      <ellipse cx="90" cy="105" rx="6" ry="7" fill="#000"/>
                    </svg>
                  </div>
                  <h2 className="text-4xl font-black text-white mb-2 drop-shadow-lg">
                    Start a conversation
                  </h2>
                  <p className="text-white/90 text-lg font-bold drop-shadow">Ask me anything</p>
                </div>
              )}
              
              {messages.map((msg, idx) => (
                <div
                  key={idx}
                  className={`mb-4 flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}
                >
                  <div
                    className={`max-w-[80%] px-5 py-3 rounded-2xl shadow-lg ${
                      msg.role === 'user'
                        ? 'bg-gradient-to-r from-purple-600 to-purple-700 text-white border-2 border-purple-400'
                        : 'bg-white/95 backdrop-blur-sm text-gray-900 border-2 border-purple-300'
                    }`}
                  >
                    {msg.type === 'image' ? (
                      <div className="w-full" dangerouslySetInnerHTML={{ __html: msg.content }} />
                    ) : (
                      <p className="text-sm leading-relaxed whitespace-pre-wrap font-medium">{msg.content}</p>
                    )}
                  </div>
                </div>
              ))}
              
              {loading && (
                <div className="flex justify-start mb-4">
                  <div className="bg-white/95 backdrop-blur-sm border-2 border-purple-300 px-5 py-3 rounded-2xl shadow-lg">
                    <div className="flex space-x-1.5">
                      <div className="w-2.5 h-2.5 bg-purple-600 rounded-full animate-bounce"></div>
                      <div className="w-2.5 h-2.5 bg-pink-500 rounded-full animate-bounce" style={{animationDelay: '0.1s'}}></div>
                      <div className="w-2.5 h-2.5 bg-orange-500 rounded-full animate-bounce" style={{animationDelay: '0.2s'}}></div>
                    </div>
                  </div>
                </div>
              )}
              
              <div ref={messagesEndRef} />
            </div>
          </div>

          <div className="p-4 bg-white/90 backdrop-blur-sm border-t-4 border-purple-600 relative z-10">
            <div className="flex gap-2 max-w-4xl mx-auto mb-3">
              <button
                onClick={() => setShowImageGen(!showImageGen)}
                className="px-4 py-3 bg-gradient-to-r from-pink-600 to-orange-500 text-white rounded-xl font-bold hover:shadow-lg transition-all flex items-center gap-2"
              >
                <Sparkles className="w-5 h-5" />
                {showImageGen ? 'Chat' : 'Image'}
              </button>
              
              {showImageGen ? (
                <>
                  <input
                    type="text"
                    value={imagePrompt}
                    onChange={(e) => setImagePrompt(e.target.value)}
                    onKeyPress={(e) => e.key === 'Enter' && generateImage()}
                    placeholder="Describe the image you want..."
                    className="flex-1 px-5 py-3 bg-white border-2 border-purple-300 rounded-xl text-gray-900 placeholder-gray-500 focus:outline-none focus:border-purple-600 focus:ring-4 focus:ring-purple-200 transition-all text-sm font-medium"
                    disabled={generatingImage}
                  />
                  <button
                    onClick={generateImage}
                    disabled={generatingImage}
                    className="px-6 py-3 bg-gradient-to-r from-purple-600 to-pink-500 hover:from-purple-700 hover:to-pink-600 text-white rounded-xl transition-all disabled:opacity-50 disabled:cursor-not-allowed shadow-lg font-bold"
                  >
                    {generatingImage ? '...' : <Sparkles className="w-5 h-5" />}
                  </button>
                </>
              ) : (
                <>
                  <input
                    type="text"
                    value={input}
                    onChange={(e) => setInput(e.target.value)}
                    onKeyPress={(e) => e.key === 'Enter' && sendMessage()}
                    placeholder="Message xixi..."
                    className="flex-1 px-5 py-3 bg-white border-2 border-purple-300 rounded-xl text-gray-900 placeholder-gray-500 focus:outline-none focus:border-purple-600 focus:ring-4 focus:ring-purple-200 transition-all text-sm font-medium"
                    disabled={loading}
                  />
                  <button
                    onClick={sendMessage}
                    disabled={loading}
                    className="px-6 py-3 bg-gradient-to-r from-purple-600 to-pink-500 hover:from-purple-700 hover:to-pink-600 text-white rounded-xl transition-all disabled:opacity-50 disabled:cursor-not-allowed shadow-lg font-bold"
                  >
                    <Send className="w-5 h-5" />
                  </button>
                </>
              )}
            </div>
          </div>
        </div>
      );
    }

    ReactDOM.render(<XixiAI />, document.getElementById('root'));
  </script>
</body>
</html>